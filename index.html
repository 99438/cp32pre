<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ä¸‡è‰ä¸›ä¸­ä¸€ç‚¹çº¢</title>
    <style>
        :root {
            --apple-green: #88d66c;
            --light-green: #f5fcf2;
            --dark-green: #5a9e3f;
            --white: #ffffff;
            --danger: #ff6b6b;
            --text: #333;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, "SF Pro Display", "Helvetica Neue", Arial, sans-serif;
            background-color: var(--light-green);
            color: var(--text);
            margin: 0;
            padding-bottom: 140px;
        }

        /* é¡¶éƒ¨çŠ¶æ€ */
        .header {
            background-color: var(--white);
            padding: 20px 15px 15px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 { margin: 0; font-size: 1.2rem; color: var(--dark-green); font-weight: 600; }
        .revenue-box { margin-top: 8px; font-size: 0.85rem; color: #666; }
        .revenue-amount { color: var(--dark-green); font-weight: bold; font-size: 1.3rem; }

        /* å•†å“ç½‘æ ¼ - å›¾ç‰‡è£å‰ªæ ¸å¿ƒ */
        .product-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 15px;
        }
        .product-card {
            background: var(--white);
            border-radius: 18px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            display: flex;
            flex-direction: column;
        }
        .img-container {
            width: 100%;
            aspect-ratio: 1 / 1; /* å¼ºåˆ¶æ­£æ–¹å½¢ */
            overflow: hidden;
            background: #eee;
        }
        .product-card img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* è‡ªåŠ¨è£å‰ªå±…ä¸­ */
            display: block;
        }
        .product-info { padding: 12px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .name { font-size: 0.9rem; font-weight: 500; height: 2.4em; overflow: hidden; margin-bottom: 5px; }
        .price { color: var(--dark-green); font-weight: bold; font-size: 1.1rem; margin-bottom: 4px; }
        .stock-label { font-size: 0.7rem; color: #999; margin-bottom: 8px; }
        .add-btn {
            background: var(--apple-green);
            color: white; border: none; width: 100%;
            padding: 10px; border-radius: 10px; font-weight: bold; font-size: 0.9rem;
        }

        /* åº•éƒ¨æ“ä½œæ  */
        .footer {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(15px);
            border-top: 1px solid #eee;
            padding: 15px 20px calc(15px + env(safe-area-inset-bottom));
            z-index: 200;
        }
        .footer-main { display: flex; justify-content: space-between; align-items: center; }
        .cart-summary { font-size: 1.4rem; font-weight: 800; color: var(--dark-green); }
        .btn-group { display: flex; gap: 10px; }
        
        .btn-circle {
            background: #f0f0f0; border: none; padding: 10px 15px;
            border-radius: 20px; font-size: 0.85rem; font-weight: 500;
        }
        .btn-pay {
            background: var(--dark-green); color: white; border: none;
            padding: 10px 25px; border-radius: 20px; font-weight: bold;
        }

        /* æ•°é‡åŠ å‡ç»„ä»¶ */
        .qty-control {
            display: flex;
            align-items: center;
            background: #f7f7f7;
            border-radius: 10px;
            padding: 2px;
        }
        .qty-btn {
            width: 32px; height: 32px; border: none; background: white;
            border-radius: 8px; font-size: 1.2rem; font-weight: bold;
            color: var(--dark-green); box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .qty-num { width: 40px; text-align: center; font-weight: bold; }

        /* å¼¹çª— */
        .modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); z-index: 1000;
            align-items: flex-end;
        }
        .modal-content {
            background: white; width: 100%; max-height: 85vh;
            border-radius: 24px 24px 0 0; padding: 25px;
            overflow-y: auto; animation: slideUp 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 0; border-bottom: 1px solid #f2f2f2;
        }
        .order-card {
            background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 12px;
            font-size: 0.85rem; border-left: 5px solid var(--apple-green);
        }
    </style>
</head>
<body>

<div class="header">
    <h1>ğŸ æ‘†æ‘Šæ”¶é“¶åŠ©æ‰‹</h1>
    <div class="revenue-box">ä»Šæ—¥è¥æ”¶: <span class="revenue-amount">ï¿¥<span id="total-revenue">0.00</span></span></div>
</div>

<div class="product-grid" id="product-list"></div>

<div class="footer">
    <div class="footer-main">
        <div class="cart-preview" onclick="showCart()">
            <div style="font-size: 0.75rem; color: #888;">å·²é€‰ <span id="cart-count">0</span> ä»¶ (ç‚¹æ­¤ä¿®æ”¹)</div>
            <div class="cart-summary">ï¿¥<span id="cart-total">0</span></div>
        </div>
        <div class="btn-group">
            <button class="btn-circle" onclick="showModal('history-modal')">å†å²</button>
            <button class="btn-circle" onclick="showModal('stock-modal')">åº“å­˜</button>
            <button class="btn-pay" onclick="checkout()">ç»“ç®—</button>
        </div>
    </div>
</div>

<div class="modal" id="cart-modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
            <h3 style="margin:0">ç¡®è®¤è®¢å•å†…å®¹</h3>
            <button class="btn-circle" onclick="closeModal('cart-modal')">è¿”å›</button>
        </div>
        <div id="cart-detail-list"></div>
        <div style="margin-top:25px; text-align:right;">
            <span style="color:#888">åˆè®¡ï¼š</span>
            <span style="font-size:1.5rem; font-weight:bold; color:var(--dark-green)">ï¿¥<span id="cart-modal-total">0</span></span>
        </div>
        <button class="add-btn" style="margin-top:20px; padding:15px; font-size:1.1rem;" onclick="checkout()">ç¡®è®¤ä¸‹å•</button>
    </div>
</div>

<div class="modal" id="history-modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3>é”€å”®å†å²</h3>
            <button class="btn-circle" onclick="clearHistory()" style="color:var(--danger)">æ¸…ç©º</button>
        </div>
        <div id="order-history-list"></div>
        <button class="add-btn" style="margin-top:20px; background:#eee; color:#666;" onclick="closeModal('history-modal')">å…³é—­</button>
    </div>
</div>

<div class="modal" id="stock-modal">
    <div class="modal-content">
        <h3>ä¿®æ”¹åº“å­˜æ•°é‡</h3>
        <div id="stock-list"></div>
        <button class="add-btn" style="margin-top:20px;" onclick="closeModal('stock-modal')">ä¿å­˜ä¿®æ”¹</button>
    </div>
</div>

<script>
    // å•†å“é…ç½®
    const productsConfig = [
        { id: 1, img: '1.jpg', price: 48, name: 'å§‹å…±æ˜¥é£å®¹æ˜“åˆ«' },
        { id: 2, img: '2.jpg', price: 28, name: 'æˆ‘å’Œä½ å’Œå¤§åƒä¸–ç•Œ' },
        { id: 3, img: '3.jpg', price: 18, name: 'æœ¨è´¨æŒ‚ä»¶' },
        { id: 4, img: '4.jpg', price: 10, name: 'è´´çº¸' },
        { id: 5, img: '5.jpg', price: 8, name: 'æ»´èƒ¶æŒ‚ä»¶' },
        { id: 6, img: '6.jpg', price: 12, name: 'æœ¨è´¨ç«‹ç‰Œ' },
        { id: 7, img: '7.jpg', price: 12, name: 'æ‰“å¡æ£’' }
    ];

    // åˆå§‹åŒ–æ•°æ®ï¼ˆä»æœ¬åœ°å­˜å‚¨è¯»å–ï¼‰
    let products = JSON.parse(localStorage.getItem('stall_v3_prods')) || productsConfig.map(p => ({...p, stock: 99}));
    let history = JSON.parse(localStorage.getItem('stall_v3_hist')) || [];
    let revenue = parseFloat(localStorage.getItem('stall_v3_rev')) || 0;
    
    // è´­ç‰©è½¦ï¼šç”¨ Map ç»“æ„å­˜å‚¨ {å•†å“ID: æ•°é‡}
    let cart = {}; 

    function init() {
        renderProducts();
        updateUI();
    }

    // æ¸²æŸ“ä¸»åˆ—è¡¨
    function renderProducts() {
        const list = document.getElementById('product-list');
        list.innerHTML = products.map(p => `
            <div class="product-card">
                <div class="img-container">
                    <img src="${p.img}" onerror="this.src='https://via.placeholder.com/300/88d66c/ffffff?text=${encodeURIComponent(p.name)}'">
                </div>
                <div class="product-info">
                    <div class="name">${p.name}</div>
                    <div class="price">ï¿¥${p.price}</div>
                    <div class="stock-label">å‰©ä½™: ${p.stock}</div>
                    <button class="add-btn" onclick="addToCart(${p.id})">åŠ å…¥å•å­</button>
                </div>
            </div>
        `).join('');
    }

    // è´­ç‰©è½¦é€»è¾‘
    function addToCart(id) {
        const p = products.find(x => x.id === id);
        if(p.stock <= 0) return alert('åº“å­˜ä¸è¶³å•¦ï¼');
        cart[id] = (cart[id] || 0) + 1;
        updateUI();
    }

    function changeQty(id, delta) {
        if (!cart[id]) return;
        const p = products.find(x => x.id === id);
        
        if (delta > 0 && cart[id] >= p.stock) {
            alert('ä¸èƒ½è¶…è¿‡å½“å‰åº“å­˜å“¦');
            return;
        }

        cart[id] += delta;
        if (cart[id] <= 0) delete cart[id];
        
        updateUI();
        renderCartDetail();
    }

    function renderCartDetail() {
        const list = document.getElementById('cart-detail-list');
        const ids = Object.keys(cart);
        
        if(ids.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:40px; color:#ccc;">è´­ç‰©è½¦ç©ºç©ºå¦‚ä¹Ÿ</div>';
            return;
        }

        list.innerHTML = ids.map(id => {
            const item = products.find(p => p.id == id);
            return `
                <div class="list-item">
                    <div>
                        <div style="font-weight:500">${item.name}</div>
                        <div style="color:var(--dark-green); font-size:0.8rem">ï¿¥${item.price} / ä»¶</div>
                    </div>
                    <div class="qty-control">
                        <button class="qty-btn" onclick="changeQty(${id}, -1)">-</button>
                        <div class="qty-num">${cart[id]}</div>
                        <button class="qty-btn" onclick="changeQty(${id}, 1)">+</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    // ç»“ç®—
    function checkout() {
        const ids = Object.keys(cart);
        if(ids.length === 0) return alert('è¿˜æ²¡é€‰ä¸œè¥¿å‘¢');
        
        let subTotal = 0;
        let itemNames = [];

        ids.forEach(id => {
            const p = products.find(x => x.id == id);
            const count = cart[id];
            p.stock -= count;
            subTotal += p.price * count;
            itemNames.push(`${p.name}x${count}`);
        });

        revenue += subTotal;
        history.unshift({
            time: new Date().toLocaleTimeString(),
            items: itemNames.join('ï¼Œ'),
            amount: subTotal
        });

        cart = {};
        saveData();
        updateUI();
        renderProducts();
        closeModal('cart-modal');
        alert('è®°è´¦æˆåŠŸï¼è¥æ”¶ +ï¿¥' + subTotal);
    }

    // åŸºç¡€åŠŸèƒ½
    function updateUI() {
        let count = 0;
        let total = 0;
        Object.keys(cart).forEach(id => {
            const p = products.find(x => x.id == id);
            count += cart[id];
            total += p.price * cart[id];
        });

        document.getElementById('cart-total').innerText = total;
        document.getElementById('cart-modal-total').innerText = total;
        document.getElementById('cart-count').innerText = count;
        document.getElementById('total-revenue').innerText = revenue.toFixed(2);
    }

    function renderStock() {
        const list = document.getElementById('stock-list');
        list.innerHTML = products.map(p => `
            <div class="list-item">
                <span>${p.name}</span>
                <input type="number" style="width:70px; padding:8px; border:1px solid #ddd; border-radius:8px; text-align:center" 
                    value="${p.stock}" onchange="updateStockValue(${p.id}, this.value)">
            </div>
        `).join('');
    }

    function updateStockValue(id, val) {
        const p = products.find(x => x.id === id);
        p.stock = parseInt(val) || 0;
        saveData();
        renderProducts();
    }

    function renderHistory() {
        const list = document.getElementById('order-history-list');
        if(history.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#ccc; padding:30px;">ä»Šæ—¥è¿˜æ²¡å¼€å¼ ~</div>';
            return;
        }
        list.innerHTML = history.map(o => `
            <div class="order-card">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <strong style="color:var(--dark-green); font-size:1.1rem;">ï¿¥${o.amount}</strong>
                    <span style="color:#999">${o.time}</span>
                </div>
                <div style="color:#666;">æ˜ç»†: ${o.items}</div>
            </div>
        `).join('');
    }

    function saveData() {
        localStorage.setItem('stall_v3_prods', JSON.stringify(products));
        localStorage.setItem('stall_v3_hist', JSON.stringify(history));
        localStorage.setItem('stall_v3_rev', revenue.toString());
    }

    function clearHistory() {
        if(confirm('ç¡®å®šè¦æ¸…ç©ºä»Šå¤©çš„è¥æ”¶å’Œå†å²è®°å½•å—ï¼Ÿ')) {
            history = []; revenue = 0;
            saveData(); updateUI(); renderHistory();
        }
    }

    // å¼¹çª—é€»è¾‘
    function showModal(id) {
        document.getElementById(id).style.display = 'flex';
        if(id === 'history-modal') renderHistory();
        if(id === 'stock-modal') renderStock();
    }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function showCart() { renderCartDetail(); showModal('cart-modal'); }

    init();
</script>
</body>
</html>
